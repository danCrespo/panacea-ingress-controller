name: Build and Push Docker Image

on:
  push:
    tags:
      - "v*"

jobs:
  image-build:
    name: Build and Push Docker Image
    runs-on: ubuntu-latest
    outputs:
      RESULT: ${{ steps.toLowercase.outputs.RESULT }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: To Lowercase
        id: toLowercase
        shell: bash
        working-directory: ${{ github.workspace }}
        env:
          GH_REPO: ${{ github.repository }}
        run: |
          GH_USER=${GH_REPO%%/*}
          REPO=${GH_REPO##*/}
          echo "RESULT=${GH_USER,,}/${REPO,,}" >> $GITHUB_OUTPUT

      - name: Build and push Docker image
        uses: docker/build-push-action@f2a1d5e99d037542a71f64918e516c093c6f3fc4
        with:
          context: .
          file: ./Dockerfile
          platforms: linux/amd64
          push: true
          tags: ghcr.io/${{ steps.toLowercase.outputs.RESULT }}:${{ github.ref_name }}
          build-args: |
            VERSION=${{ github.ref_name }}
            BUILD_DATE=${{ github.event.head_commit.timestamp }}
            GIT_COMMIT=${{ github.sha }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
        id: build-and-push

      - name: Image digest
        shell: bash
        run: |
          echo "Image digest: ${{ steps.build-and-push.outputs.digest }}"
          echo "Image tag: ghcr.io/${{ steps.toLowercase.outputs.RESULT }}:${{ github.ref_name }}"
  notify:
    name: Notify on Failure
    needs: image-build
    runs-on: ubuntu-latest
    env:
      GITHUB_SHA: ${{ github.sha }}
      GITHUB_REF: ${{ github.ref }}
      GITHUB_REPOSITORY: ${{ github.repository }}
      RESULT: ${{ needs.image-build.outputs.RESULT }}

    steps:
      - name: Send GH notification
        uses: actions/github-script@v6
        if: failure()
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issueTitle = `ðŸš¨ Workflow ${process.env.GITHUB_REF} failed`;
            const issueBody = `The Docker image build and push process failed for commit ${process.env.GITHUB_SHA} on branch ${process.env.GITHUB_REF}.
            Please check the [Actions tab](${process.env.GITHUB_SERVER_URL}/${process.env.GITHUB_REPOSITORY}/actions) for more details.`;
            const [owner, repo] = process.env.GITHUB_REPOSITORY.split('/');

            // Create a new issue
            await github.rest.issues.create({
              owner,
              repo,
              title: issueTitle,
              body: issueBody,
              labels: ['build-failure'],
            });

      - name: Notify Success
        if: success()
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issueTitle = `âœ… Workflow ${process.env.GITHUB_REF} succeeded`;
            const issueBody = `The Docker image build and push process succeeded for commit ${process.env.GITHUB_SHA} on branch ${process.env.GITHUB_REF}.
            You can find the built image at ghcr.io/${process.env.RESULT}:${process.env.GITHUB_REF}.`;
            const [owner, repo] = process.env.GITHUB_REPOSITORY.split('/');

            // Create a new issue
            await github.rest.issues.create({
              owner,
              repo,
              title: issueTitle,
              body: issueBody,
              labels: ['build-success'],
            });

      - name: Send Slack Notification
        if: always()
        uses: slackapi/slack-github-action@v2.1.1
        with:
          webhook-type: webhook-trigger
          webhook: ${{ secrets.SLACK_WEBHOOK_URL }}
          payload: |
            "status": "${{ job.status }}",
            "repository": "${{ github.repository }}",
            "tag": "${{ github.ref }}",
            "commit": "${{ github.sha }}"
